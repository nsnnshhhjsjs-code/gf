name: Automated Video Generator with Download Link

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Live.py Mode (1=video, 2=with_template)'
        required: true
        type: choice
        options:
          - '1'
          - '2'

jobs:
  generate-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        ffmpeg -version
    
    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib Pillow numpy opencv-python moviepy gtts pydub
    
    - name: Verify Required Files
      run: |
        echo "ðŸ” Checking required files..."
        ls -la
        
        if [ ! -f "drive_token.pickle" ]; then
          echo "âŒ ERROR: drive_token.pickle not found!"
          exit 1
        fi
        
        if [ ! -f "video.txt" ]; then
          echo "âŒ ERROR: video.txt not found!"
          exit 1
        fi
        
        if [ ! -f "github_video_generator_download.py" ]; then
          echo "âŒ ERROR: github_video_generator_download.py not found!"
          exit 1
        fi
        
        if [ ! -f "live.py" ]; then
          echo "âŒ ERROR: live.py not found!"
          exit 1
        fi
        
        echo "âœ… All required files present"
        echo ""
        echo "ðŸ“„ video.txt content:"
        cat video.txt
    
    - name: Run Video Generator
      run: |
        echo "ðŸš€ Starting video generation..."
        echo "Mode: ${{ inputs.mode }}"
        python github_video_generator_download.py ${{ inputs.mode }}
      env:
        PYTHONUNBUFFERED: 1
    
    - name: List Generated Files
      if: always()
      run: |
        echo "ðŸ“‚ Work directory contents:"
        ls -lah work/ || echo "No work directory"
        
        echo ""
        echo "ðŸ“‚ Output directory contents:"
        ls -lah output/ || echo "No output directory"
        
        echo ""
        echo "ðŸ“Š Output file sizes:"
        du -h output/* 2>/dev/null || echo "No output files"
    
    - name: ðŸŽ‰ Upload Videos as Artifacts (Download Links)
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: generated-videos-${{ github.run_number }}
        path: output/*.mp4
        retention-days: 7
        if-no-files-found: warn
    
    - name: ðŸ“ Create Download Instructions
      if: success()
      run: |
        echo "# âœ… Video Generation Complete!" > DOWNLOAD.md
        echo "" >> DOWNLOAD.md
        echo "## ðŸ“¥ How to Download:" >> DOWNLOAD.md
        echo "" >> DOWNLOAD.md
        echo "1. Go to this workflow run" >> DOWNLOAD.md
        echo "2. Scroll to bottom of page" >> DOWNLOAD.md
        echo "3. Find **Artifacts** section" >> DOWNLOAD.md
        echo "4. Click on: **generated-videos-${{ github.run_number }}**" >> DOWNLOAD.md
        echo "5. ZIP file will download automatically" >> DOWNLOAD.md
        echo "6. Extract ZIP to get your videos" >> DOWNLOAD.md
        echo "" >> DOWNLOAD.md
        echo "## ðŸ“Š Generated Videos:" >> DOWNLOAD.md
        echo "" >> DOWNLOAD.md
        echo "\`\`\`" >> DOWNLOAD.md
        ls -lh output/*.mp4 2>/dev/null || echo "No videos found" >> DOWNLOAD.md
        echo "\`\`\`" >> DOWNLOAD.md
        echo "" >> DOWNLOAD.md
        echo "ðŸ”— **Direct Link:** Click 'Artifacts' below this workflow" >> DOWNLOAD.md
    
    - name: Upload Download Instructions
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: DOWNLOAD-INSTRUCTIONS
        path: DOWNLOAD.md
        retention-days: 7
    
    - name: Upload Debug Artifacts (Failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-artifacts-${{ github.run_number }}
        path: |
          work/
          output/
          *.log
        retention-days: 3
        if-no-files-found: ignore
    
    - name: ðŸ’¬ Job Summary
      if: always()
      run: |
        echo "## ðŸ“Š Video Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "output" ] && [ "$(ls -A output/*.mp4 2>/dev/null)" ]; then
          echo "### âœ… Success!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated Videos:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh output/*.mp4 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Your Videos:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Scroll to bottom of this page" >> $GITHUB_STEP_SUMMARY
          echo "2. Find **Artifacts** section" >> $GITHUB_STEP_SUMMARY
          echo "3. Click: **generated-videos-${{ github.run_number }}**" >> $GITHUB_STEP_SUMMARY
          echo "4. ZIP file downloads automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **Retention:** 7 days" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check debug artifacts for details" >> $GITHUB_STEP_SUMMARY
        fi
